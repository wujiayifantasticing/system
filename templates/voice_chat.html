<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è¯­éŸ³èŠå¤© - AIè¯†åˆ«ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/utilities.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* è¯­éŸ³èŠå¤©è“è‰²ä¸»é¢˜ */
        body {
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: auto;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
        }

        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 120px 20px 40px 20px;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .chat-container {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header-chat {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header-chat h1 {
            font-size: 2em;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .header-chat p {
            font-size: 1em;
            opacity: 0.9;
        }

        .content {
            padding: 25px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .model-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .model-select {
            padding: 10px 15px;
            border: 2px solid #e6f3ff;
            border-radius: var(--border-radius-sm);
            background: #f8f9ff;
            color: #333;
            font-size: 14px;
            min-width: 160px;
            transition: var(--transition);
        }

        .model-select:focus {
            outline: none;
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .model-status {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .btn-chat {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1em;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            min-width: 140px;
            justify-content: center;
        }

        .btn-record {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }

        .btn-stop {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-chat:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.4);
        }

        .btn-chat:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9ff;
            font-size: 1em;
            color: #4361ee;
            border-left: 4px solid #4361ee;
            font-weight: 600;
        }

        .results {
            background: #f8f9ff;
            border-radius: var(--border-radius-sm);
            padding: 20px;
            margin-bottom: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid #e6f3ff;
        }

        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius-sm);
            border-left: 4px solid #4361ee;
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .result-label {
            font-weight: 600;
            color: #4361ee;
            margin-bottom: 10px;
            display: block;
            font-size: 1em;
        }

        .result-content {
            color: #333;
            line-height: 1.6;
            min-height: 20px;
        }

        .audio-player {
            width: 100%;
            margin-top: 10px;
            border-radius: 6px;
            background: white;
        }

        .audio-status {
            padding: 8px;
            text-align: center;
            color: #666;
            font-style: italic;
            background: #e6f3ff;
            border-radius: var(--border-radius-sm);
        }

        .audio-status a {
            color: #4361ee;
            text-decoration: none;
            font-weight: 500;
        }

        .audio-status a:hover {
            text-decoration: underline;
        }

        .tip-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }

        /* å½•éŸ³åŠ¨ç”»æ•ˆæœ */
        .recording-animation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px;
            margin: 10px 0;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            background: #4361ee;
            border-radius: 50%;
            animation: recordingPulse 1.5s ease-in-out infinite;
        }

        .recording-dot:nth-child(2) { animation-delay: 0.2s; }
        .recording-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes recordingPulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
        }

        /* éŸ³é¢‘æ³¢å½¢å¯è§†åŒ– */
        .wave-visualization {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            height: 40px;
            margin: 10px 0;
        }

        .wave-bar {
            width: 3px;
            height: 20px;
            background: #4361ee;
            border-radius: 2px;
            animation: wave 1.5s ease-in-out infinite;
        }

        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        .wave-bar:nth-child(6) { animation-delay: 0.5s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1.5); }
        }

        /* å¯¹è¯å†å² */
        .conversation-history {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border-radius: var(--border-radius-sm);
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e6f3ff;
        }

        .history-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: var(--border-radius-sm);
            font-size: 0.9em;
        }

        .history-user {
            background: #e6f3ff;
            color: #4361ee;
            margin-left: auto;
            text-align: right;
            max-width: 80%;
        }

        .history-bot {
            background: #f8f9ff;
            color: #333;
            margin-right: auto;
            max-width: 80%;
        }

        /* æ¨¡å‹ä¿¡æ¯æç¤º */
        .model-info {
            background: #e6f3ff;
            padding: 10px 15px;
            border-radius: var(--border-radius-sm);
            margin-top: 10px;
            border-left: 3px solid #4361ee;
        }

        .model-info h4 {
            margin: 0 0 5px 0;
            color: #4361ee;
            font-size: 14px;
        }

        .model-info p {
            margin: 0;
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                padding: 110px 15px 30px 15px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }
            
            .model-controls {
                order: -1;
                width: 100%;
                justify-content: center;
                margin-bottom: 10px;
            }
            
            .model-select {
                width: 100%;
                max-width: 280px;
            }
            
            .btn-chat {
                width: 100%;
                max-width: 280px;
            }
            
            .header-chat h1 {
                font-size: 1.6em;
            }
            
            .content {
                padding: 20px;
            }

            .result-item {
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            .header-chat {
                padding: 20px 15px;
            }
            
            .header-chat h1 {
                font-size: 1.4em;
            }
            
            .content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo-container">
                <img src="../static/images/logo.jpg" alt="ç³»ç»ŸLogo" class="logo">
                <h1 class="welcome-text">æ™ºèƒ½è¯­éŸ³èŠå¤©</h1>
            </div>

            <div class="nav-menu">
                <div class="dropdown">
                    <button class="btn" onclick="navigate('home')">
                        <i class="fas fa-home"></i>&nbsp;é¦–é¡µ
                    </button>
                </div>

                <div class="dropdown" id="faceRecognitionDropdown">
                    <button class="btn dropdown-btn" onclick="toggleDropdown('faceRecognitionDropdown')">
                        <i class="fas fa-user-circle"></i>&nbsp;äººè„¸è¯†åˆ«
                    </button>
                    <div class="dropdown-content">
                        <button class="btn" onclick="navigate('feature')">
                            <i class="fas fa-project-diagram"></i>&nbsp;äººè„¸ç‰¹å¾åˆ†æ
                        </button>
                        <button class="btn" onclick="navigate('compare')">
                            <i class="fas fa-compress-alt"></i>&nbsp;äººè„¸å¯¹æ¯”
                        </button>
                    </div>
                </div>

                <div class="dropdown" id="aiChatDropdown">
                    <button class="btn dropdown-btn" onclick="toggleDropdown('aiChatDropdown')">
                        <i class="fas fa-robot"></i>&nbsp;AIå¯¹è¯
                    </button>
                    <div class="dropdown-content">
                        <button class="btn" onclick="navigate('chat')">
                            <i class="fas fa-comments"></i>&nbsp;æ ¡å›­é—®ç­”
                        </button>
                        <button class="btn" onclick="navigate('voice_chat')">
                            <i class="fas fa-microphone-alt"></i>&nbsp;è¯­éŸ³èŠå¤©
                        </button>
                    </div>
                </div>

                <div class="dropdown" id="speechDropdown">
                    <button class="btn dropdown-btn" onclick="toggleDropdown('speechDropdown')">
                        <i class="fas fa-microphone-alt"></i>&nbsp;è¯­éŸ³æŠ€æœ¯
                    </button>
                    <div class="dropdown-content">
                        <button class="btn" onclick="navigate('speech_recognition')">
                            <i class="fas fa-microphone"></i>&nbsp;è¯­éŸ³è¯†åˆ«
                        </button>
                        <button class="btn" onclick="navigate('speech_synthesis')">
                            <i class="fas fa-volume-up"></i>&nbsp;è¯­éŸ³åˆæˆ
                        </button>
                        <button class="btn" onclick="navigate('speech_information')">
                            <i class="fas fa-info-circle"></i>&nbsp;è¯­éŸ³ä¿¡æ¯
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="chat-container">
            <div class="header-chat">
                <h1>ğŸ¤ æ™ºèƒ½è¯­éŸ³èŠå¤©</h1>
                <p>ä¸AIè¿›è¡Œè‡ªç„¶çš„è¯­éŸ³å¯¹è¯ï¼Œä½“éªŒæ™ºèƒ½è¯­éŸ³äº¤äº’çš„é­…åŠ›</p>
            </div>
            
            <div class="content">
                <div class="controls">
                    <div class="model-controls">
                        <select id="voice-model-select" class="model-select">
                            <option value="lite">æ˜Ÿç«Liteæ¨¡å‹ï¼ˆå¿«é€Ÿå“åº”ï¼‰</option>
                            <option value="x1">æ˜Ÿç«X1æ¨¡å‹ï¼ˆæ·±åº¦æ€è€ƒï¼‰</option>
                        </select>
                        <span class="model-status" id="modelStatus">å½“å‰ï¼šLiteæ¨¡å‹</span>
                    </div>
                    <button id="startBtn" class="btn-chat btn-record">
                        <i class="fas fa-microphone"></i> å¼€å§‹å½•éŸ³
                    </button>
                    <button id="stopBtn" class="btn-chat btn-stop" disabled>
                        <i class="fas fa-stop"></i> åœæ­¢å½•éŸ³
                    </button>
                </div>

                <!-- æ¨¡å‹ä¿¡æ¯æç¤º -->
                <div class="model-info">
                    <h4><i class="fas fa-lightbulb"></i> æ¨¡å‹é€‰æ‹©è¯´æ˜ï¼š</h4>
                    <p><strong>æ˜Ÿç«Liteæ¨¡å‹</strong>ï¼šå“åº”é€Ÿåº¦å¿«ï¼Œé€‚åˆæ—¥å¸¸å¯¹è¯å’Œç®€å•é—®é¢˜</p>
                    <p><strong>æ˜Ÿç«X1æ¨¡å‹</strong>ï¼šæ€è€ƒæ›´æ·±å…¥ï¼Œé€‚åˆå¤æ‚é—®é¢˜å’Œæ·±åº¦åˆ†æ</p>
                </div>
                
                <div class="status" id="status">
                    <i class="fas fa-info-circle"></i> ç‚¹å‡»"å¼€å§‹å½•éŸ³"æŒ‰é’®å¼€å§‹è¯­éŸ³å¯¹è¯
                </div>
                
                <div class="results">
                    <div class="result-item">
                        <span class="result-label">æ‚¨è¯´çš„è¯ï¼š</span>
                        <div class="result-content" id="recognizedText">
                            - - -
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">AIå›å¤ï¼š</span>
                        <div class="result-content" id="aiReply">
                            - - -
                        </div>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">è¯­éŸ³å›å¤ï¼š</span>
                        <div class="result-content">
                            <!-- éŸ³é¢‘æ³¢å½¢å¯è§†åŒ– -->
                            <div class="wave-visualization">
                                <div class="wave-bar"></div>
                                <div class="wave-bar"></div>
                                <div class="wave-bar"></div>
                                <div class="wave-bar"></div>
                                <div class="wave-bar"></div>
                                <div class="wave-bar"></div>
                            </div>
                            
                            <audio id="audioPlayer" controls class="audio-player" style="display: none;">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                            </audio>
                            <div id="audioStatus" class="audio-status">æš‚æ— éŸ³é¢‘ï¼Œå®Œæˆå¯¹è¯åå³å¯æ’­æ”¾è¯­éŸ³å›å¤</div>
                        </div>
                    </div>

                    <!-- å¯¹è¯å†å² -->
                    <div class="conversation-history" id="conversationHistory" style="display: none;">
                        <div class="history-item history-user">
                            ä½ å¥½ï¼
                        </div>
                        <div class="history-item history-bot">
                            æ‚¨å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚
                        </div>
                    </div>
                </div>
                
                <div class="tip-text">
                    <i class="fas fa-lightbulb"></i> æç¤ºï¼šæŒ‰ç©ºæ ¼é”®å¼€å§‹å½•éŸ³ï¼ŒESCé”®åœæ­¢å½•éŸ³
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script>
        // è¯­éŸ³èŠå¤©åŠŸèƒ½
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let conversationHistory = [];
        let currentModel = 'lite'; // é»˜è®¤æ¨¡å‹

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDiv = document.getElementById('status');
        const recognizedTextDiv = document.getElementById('recognizedText');
        const aiReplyDiv = document.getElementById('aiReply');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioStatus = document.getElementById('audioStatus');
        const conversationHistoryDiv = document.getElementById('conversationHistory');
        const modelSelect = document.getElementById('voice-model-select');
        const modelStatus = document.getElementById('modelStatus');

        // æ¨¡å‹é€‰æ‹©äº‹ä»¶
        modelSelect.addEventListener('change', function(e) {
            currentModel = e.target.value;
            const modelName = e.target.selectedOptions[0].text.split('ï¼ˆ')[0];
            modelStatus.textContent = `å½“å‰ï¼š${modelName}`;
            statusDiv.innerHTML = `<i class="fas fa-info-circle"></i> å·²åˆ‡æ¢åˆ°${modelName}ï¼Œç‚¹å‡»"å¼€å§‹å½•éŸ³"å¼€å§‹å¯¹è¯`;
        });

        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–Edgeç­‰ç°ä»£æµè§ˆå™¨';
            startBtn.disabled = true;
        }

        startBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);

        async function startRecording() {
            try {
                statusDiv.innerHTML = '<div class="recording-animation"><div class="recording-dot"></div><div class="recording-dot"></div><div class="recording-dot"></div></div> è¯·æ±‚éº¦å…‹é£æƒé™...';
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = processAudio;
                
                mediaRecorder.start();
                isRecording = true;
                
                startBtn.disabled = true;
                stopBtn.disabled = false;
                modelSelect.disabled = true;
                statusDiv.innerHTML = '<div class="recording-animation"><div class="recording-dot"></div><div class="recording-dot"></div><div class="recording-dot"></div></div> <strong>å½•éŸ³ä¸­...</strong> è¯·å¼€å§‹è¯´è¯';
                
            } catch (error) {
                console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', error);
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> æ— æ³•è®¿é—®éº¦å…‹é£: ' + error.message;
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // åœæ­¢æ‰€æœ‰éŸ³è½¨
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                startBtn.disabled = false;
                stopBtn.disabled = true;
                modelSelect.disabled = false;
                statusDiv.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> å¤„ç†éŸ³é¢‘ä¸­...';
            }
        }

        async function processAudio() {
            try {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                
                // è½¬æ¢ä¸ºWAVæ ¼å¼
                const wavBlob = await convertToWav(audioBlob);
                
                // ä¸Šä¼ åˆ°æœåŠ¡å™¨
                await uploadAudio(wavBlob);
                
            } catch (error) {
                console.error('éŸ³é¢‘å¤„ç†å¤±è´¥:', error);
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> éŸ³é¢‘å¤„ç†å¤±è´¥: ' + error.message;
            }
        }

        async function convertToWav(audioBlob) {
            return new Promise((resolve, reject) => {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const fileReader = new FileReader();
                
                fileReader.onload = function() {
                    audioContext.decodeAudioData(fileReader.result, (audioBuffer) => {
                        // è½¬æ¢ä¸ºWAVæ ¼å¼
                        const wavBuffer = encodeWAV(audioBuffer);
                        const wavBlob = new Blob([wavBuffer], { type: 'audio/wav' });
                        resolve(wavBlob);
                    }, reject);
                };
                fileReader.onerror = reject;
                fileReader.readAsArrayBuffer(audioBlob);
            });
        }

        // WAVç¼–ç å‡½æ•°
        function encodeWAV(audioBuffer) {
            const numChannels = 1;
            const sampleRate = 16000;
            const format = 1; // PCM
            const bitDepth = 16;
            
            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;
            
            const buffer = new ArrayBuffer(44 + audioBuffer.length * blockAlign);
            const view = new DataView(buffer);
            
            // WAVæ–‡ä»¶å¤´
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + audioBuffer.length * blockAlign, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, audioBuffer.length * blockAlign, true);
            
            // éŸ³é¢‘æ•°æ®
            floatTo16BitPCM(view, 44, audioBuffer.getChannelData(0));
            
            return buffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function floatTo16BitPCM(view, offset, input) {
            for (let i = 0; i < input.length; i++, offset += 2) {
                const s = Math.max(-1, Math.min(1, input[i]));
                view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
        }

        async function uploadAudio(audioBlob) {
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, `voice_chat_${Date.now()}.wav`);
                formData.append('model_type', currentModel); // ä¼ é€’æ¨¡å‹ç±»å‹
                
                console.log(`å¼€å§‹ä¸Šä¼ éŸ³é¢‘ï¼Œä½¿ç”¨æ¨¡å‹: ${currentModel}`);
                const response = await fetch('/api/voice_chat', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('æœåŠ¡å™¨å“åº”:', data);
                
                if (data.success) {
                    // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
                    recognizedTextDiv.textContent = data.recognized_text || 'ï¼ˆæ— æ³•è¯†åˆ«ï¼‰';
                    aiReplyDiv.textContent = data.ai_reply;
                    
                    // æ·»åŠ åˆ°å¯¹è¯å†å²
                    addToHistory(data.recognized_text || 'ï¼ˆè¯­éŸ³æ¶ˆæ¯ï¼‰', data.ai_reply);
                    
                    // æ’­æ”¾éŸ³é¢‘å›å¤
                    if (data.audio_url) {
                        const newAudio = new Audio();
                        newAudio.src = data.audio_url + '?t=' + Date.now();
                        newAudio.controls = true;
                        newAudio.className = 'audio-player';
                        
                        // æ›¿æ¢æ—§çš„éŸ³é¢‘å…ƒç´ 
                        const oldAudio = document.getElementById('audioPlayer');
                        oldAudio.parentNode.replaceChild(newAudio, oldAudio);
                        newAudio.id = 'audioPlayer';
                        
                        // æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨
                        newAudio.style.display = 'block';
                        audioStatus.style.display = 'none';
                        
                        // å°è¯•æ’­æ”¾
                        newAudio.play().then(() => {
                            console.log('éŸ³é¢‘æ’­æ”¾æˆåŠŸ');
                        }).catch(e => {
                            console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»:', e);
                            audioStatus.innerHTML = '<i class="fas fa-volume-up"></i> <a href="#" onclick="document.getElementById(\'audioPlayer\').play(); return false;">ç‚¹å‡»æ’­æ”¾è¯­éŸ³å›å¤</a>';
                            audioStatus.style.display = 'block';
                        });
                    }
                    
                    statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #28a745;"></i> å¯¹è¯å®Œæˆï¼';
                    
                } else {
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ' + (data.error || 'å¤„ç†å¤±è´¥');
                }
                
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ç½‘ç»œé”™è¯¯: ' + error.message;
            }
        }

        // æ·»åŠ åˆ°å¯¹è¯å†å²
        function addToHistory(userMessage, botMessage) {
            conversationHistory.push({
                user: userMessage,
                bot: botMessage,
                timestamp: new Date(),
                model: currentModel
            });
            
            // æ›´æ–°å†å²æ˜¾ç¤º
            updateHistoryDisplay();
        }

        // æ›´æ–°å†å²æ˜¾ç¤º
        function updateHistoryDisplay() {
            const historyContainer = document.getElementById('conversationHistory');
            historyContainer.innerHTML = '';
            
            conversationHistory.forEach(item => {
                // ç”¨æˆ·æ¶ˆæ¯
                const userDiv = document.createElement('div');
                userDiv.className = 'history-item history-user';
                userDiv.textContent = item.user;
                historyContainer.appendChild(userDiv);
                
                // AIå›å¤
                const botDiv = document.createElement('div');
                botDiv.className = 'history-item history-bot';
                
                // æ·»åŠ æ¨¡å‹æ ‡è¯†
                const modelBadge = document.createElement('span');
                modelBadge.style.cssText = 'font-size: 10px; color: #666; background: #e6f3ff; padding: 2px 6px; border-radius: 10px; margin-left: 8px;';
                modelBadge.textContent = item.model === 'x1' ? 'X1' : 'Lite';
                
                const contentDiv = document.createElement('div');
                contentDiv.textContent = item.bot;
                
                botDiv.appendChild(contentDiv);
                botDiv.appendChild(modelBadge);
                historyContainer.appendChild(botDiv);
            });
            
            // æ˜¾ç¤ºå†å²åŒºåŸŸ
            historyContainer.style.display = 'block';
            historyContainer.scrollTop = historyContainer.scrollHeight;
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !isRecording && !startBtn.disabled) {
                e.preventDefault();
                startRecording();
            } else if (e.code === 'Escape' && isRecording) {
                e.preventDefault();
                stopRecording();
            }
        });

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            console.log('è¯­éŸ³èŠå¤©é¡µé¢å·²åŠ è½½');
            // è®¾ç½®é»˜è®¤æ¨¡å‹çŠ¶æ€
            modelStatus.textContent = 'å½“å‰ï¼šLiteæ¨¡å‹';
        });
    </script>
</body>
</html>